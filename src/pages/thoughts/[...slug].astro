---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import GutterColumn from '../../components/ui/GutterColumn.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const allPosts = (await getCollection('blog'))
  .filter((p) => !p.data.draft && p.slug !== post.slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 2);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  month: 'long',
  day: 'numeric',
  year: 'numeric',
}).toLowerCase();
---

<BaseLayout title={`${post.data.title} â€” utpal.dev`} description={post.data.description}>
  <GutterColumn />

  <nav class="max-w-5xl mx-auto px-6 md:px-0 md:pl-16 pt-12 fade-in">
    <div class="flex items-center gap-2 font-mono text-xs" style="color: var(--text-tertiary);">
      <a href="/" class="hover:text-accent transition-colors" style="color: var(--text-tertiary);">~/home</a>
      <span>/</span>
      <a href="/thoughts" class="hover:text-accent transition-colors" style="color: var(--text-tertiary);">thoughts</a>
      <span>/</span>
      <span style="color: var(--text-primary);">{post.slug}</span>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-6 md:px-0 md:pl-16 mt-12 grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-16">

    <article class="fade-in">
      <header class="mb-12">
        <h1 class="text-4xl md:text-5xl font-semibold tracking-tight leading-tight mb-6" style="color: var(--text-primary);">
          {post.data.title}
        </h1>

        <div class="flex flex-wrap items-center gap-6 font-mono text-xs" style="color: var(--text-tertiary);">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full" style="background-color: var(--border);"></div>
            <span style="color: var(--text-primary);">utpal</span>
          </div>
          <div class="flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
            <span>{formattedDate}</span>
          </div>
          {post.data.readingTime && (
            <div class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <span>{post.data.readingTime}</span>
            </div>
          )}
          {post.data.tags.length > 0 && (
            <div class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>
              <span>{post.data.tags.join(', ')}</span>
            </div>
          )}
        </div>
      </header>

      <div class="article-content text-lg">
        <div class="my-8">
          <div class="w-full h-64 md:h-96 border rounded-sm flex items-center justify-center" style="background-color: var(--border); border-color: var(--border);">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted);"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          </div>
          <p class="text-xs mt-2 font-mono" style="color: var(--text-tertiary);">Image: cover illustration / Credit: unsplash.com</p>
        </div>

        <Content />
      </div>

      <!-- Author bio -->
      <div class="mt-20 pt-12 border-t" style="border-color: var(--border);">
        <div class="flex gap-6 items-start">
          <div class="w-16 h-16 border rounded-sm flex-shrink-0" style="background-color: var(--border); border-color: var(--border);"></div>
          <div>
            <span class="font-mono text-xs font-bold mb-1 block" style="color: var(--accent);">author</span>
            <h3 class="font-bold mb-2" style="color: var(--text-primary);">utpal</h3>
            <p class="text-sm leading-relaxed" style="color: var(--text-secondary);">
              full-stack engineer building scalable systems. currently exploring the depths of rust, typescript, and distributed databases.
            </p>
          </div>
        </div>
      </div>

      <!-- Related thoughts -->
      {allPosts.length > 0 && (
        <div class="mt-24">
          <span class="font-mono text-[0.85rem] font-medium block mb-6" style="color: var(--text-tertiary);">// related thoughts</span>
          <div class="grid md:grid-cols-2 gap-8">
            {allPosts.map((relatedPost) => (
              <a href={`/thoughts/${relatedPost.slug}`} class="group block border p-6 transition-colors" style={`border-color: var(--border); background-color: var(--surface);`}>
                <span class="font-mono text-xs block mb-2" style="color: var(--text-tertiary);">
                  {relatedPost.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).toLowerCase()}
                </span>
                <h4 class="font-semibold group-hover:text-accent transition-colors mb-2" style="color: var(--text-primary);">{relatedPost.data.title}</h4>
                <p class="text-sm line-clamp-2" style="color: var(--text-secondary);">{relatedPost.data.description}</p>
              </a>
            ))}
          </div>
        </div>
      )}
    </article>

    <!-- Sidebar -->
    <aside class="hidden lg:block">
      <div class="sticky-sidebar">
        <span class="font-mono text-[0.85rem] font-medium block mb-4" style="color: var(--text-tertiary);">// contents</span>
        <nav class="space-y-1 font-mono">
          {headings.filter(h => h.depth === 2).map((heading, i) => (
            <a href={`#${heading.slug}`} class="toc-item">
              {String(i + 1).padStart(2, '0')}. {heading.text}
            </a>
          ))}
        </nav>

        <div class="mt-12">
          <span class="font-mono text-[0.85rem] font-medium block mb-4" style="color: var(--text-tertiary);">// share</span>
          <div class="flex gap-4">
            <button class="transition-colors hover:text-accent" style="color: var(--text-tertiary);" aria-label="Share on Twitter">
              <svg width="16" height="16" viewBox="0 0 1200 1227" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/></svg>
            </button>
            <button class="transition-colors hover:text-accent" style="color: var(--text-tertiary);" aria-label="Share on LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>
            </button>
            <button class="transition-colors hover:text-accent" style="color: var(--text-tertiary);" aria-label="Copy link">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </button>
          </div>
        </div>

        <div class="mt-12 p-4 border rounded-sm" style="background-color: var(--surface); border-color: var(--border);">
          <p class="font-mono text-[10px] uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">status</p>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="font-mono text-xs" style="color: var(--text-primary);">reading now</span>
          </div>
        </div>
      </div>
    </aside>

  </main>
</BaseLayout>
