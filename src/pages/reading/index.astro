---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import GutterColumn from '../../components/ui/GutterColumn.astro';

const allReading = await getCollection('reading');

const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];

// Sort by date descending (newest first)
const sorted = allReading.sort((a, b) => {
  const [aMonth, aYear] = a.data.date.split(' ');
  const [bMonth, bYear] = b.data.date.split(' ');
  const aVal = parseInt(aYear) * 12 + months.indexOf(aMonth);
  const bVal = parseInt(bYear) * 12 + months.indexOf(bMonth);
  return bVal - aVal;
});

// Group by year
function getYear(dateStr: string): number {
  const parts = dateStr.split(' ');
  return parseInt(parts[parts.length - 1]);
}

const grouped = new Map<number, typeof sorted>();
for (const item of sorted) {
  const year = getYear(item.data.date);
  if (!grouped.has(year)) grouped.set(year, []);
  grouped.get(year)!.push(item);
}

const typeLabel: Record<string, string> = {
  book: 'Book',
  blog: 'Blog',
  video: 'Video',
};
---

<BaseLayout title="archive — utpal.dev" description="a collection of high-signal resources i've consumed.">
  <GutterColumn />
  <main class="max-w-3xl mx-auto px-6 md:px-0 md:pl-16 pt-16 md:pt-24 min-h-screen">

    <nav class="breadcrumb fade-in">
      <a href="/" class="hover:text-accent transition-colors" style="color: var(--text-tertiary);">~/home</a>
      <span class="mx-2" style="color: var(--border);">/</span>
      <span style="color: var(--text-primary);">reading</span>
    </nav>

    <section class="fade-in" style="animation-delay: 0.1s;">
      <h1 class="text-4xl font-semibold tracking-tight mb-4" style="color: var(--text-primary);">archive.</h1>
      <p class="text-sm max-w-lg leading-relaxed mb-12" style="color: var(--text-secondary);">
        a collection of high-signal resources i've consumed. mostly distributed systems, database internals, and software engineering philosophy.
      </p>

      <div class="flex flex-wrap gap-3 mb-12">
        <button class="filter-tag active" data-filter="all">all_content</button>
        <button class="filter-tag" data-filter="book">books</button>
        <button class="filter-tag" data-filter="blog">articles</button>
        <button class="filter-tag" data-filter="video">talks_&_videos</button>
      </div>
    </section>

    <section class="fade-in space-y-16" style="animation-delay: 0.2s;" id="archive-list">
      {[...grouped.entries()].map(([year, items]) => (
        <div class="archive-group" data-year={year}>
          <span class="font-mono text-[0.85rem] block mb-6" style="color: var(--text-tertiary);">// {year}</span>
          <div class="space-y-10">
            {items.map((item) => (
              <a href={`/reading/${item.slug}`} class="archive-item block" data-type={item.data.type}>
                <span class="font-mono text-[10px] absolute left-8 -top-5" style="color: var(--text-tertiary);">{item.data.date}</span>
                <div class="group cursor-pointer">
                  <h3 class="font-semibold group-hover:text-accent transition-colors" style="color: var(--text-primary);">{item.data.title}</h3>
                  <p class="text-sm mt-1" style="color: var(--text-tertiary);">
                    {item.data.author} · {typeLabel[item.data.type]}
                  </p>
                  {item.data.tags.length > 0 && (
                    <p class="text-xs font-mono mt-2" style="color: var(--text-tertiary);">
                      {item.data.tags.join(' · ')}
                    </p>
                  )}
                </div>
              </a>
            ))}
          </div>
        </div>
      ))}
    </section>

    <div class="pt-12 pb-24 text-center fade-in" style="animation-delay: 0.3s;">
      <p class="font-mono text-xs" style="color: var(--text-muted);">-- end of archive --</p>
    </div>
  </main>

  <script is:inline>
    document.querySelectorAll('.filter-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filter = btn.getAttribute('data-filter');

        document.querySelectorAll('.archive-item').forEach(item => {
          if (filter === 'all' || item.getAttribute('data-type') === filter) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });

        document.querySelectorAll('.archive-group').forEach(group => {
          const visible = group.querySelectorAll('.archive-item:not([style*="display: none"])').length;
          group.style.display = visible > 0 ? '' : 'none';
        });
      });
    });
  </script>
</BaseLayout>
